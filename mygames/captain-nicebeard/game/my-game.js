function getNewWorld(a){var b=new World(a);return b.Pa(5,15),b}function startServer(){for(var a=0;6>=a;a++)worlds.push(getNewWorld(a));io.on("connection",function(a){log.debug("New connection",a.id);var b=new Player;b.Qa(a),a.on("new-game",function(c){b.Qa(a)}),a.on("tank-state",function(a,c){b.Ra(a),c(!0)})})}function Player(){this.Sa=nextPlayerId,nextPlayerId++,this.level=0,this.qa=worlds[this.level],this.A=[],this.Ta=!0,this.pa=""}function Tank(a,b){this.N=nextTankId,nextTankId++,this.Ya=a,this.A={xa:[],ya:[]}}function Token(a,b){this.P=a,this.S=b,this.Za=nextTokenId,this.A=[],nextTokenId++}function World(a){this.G=3e5,this.height=2e3+400*a,this.width=3e3+400*a,this.A=[],this.Ua=[],this.I=[],this.J=[],this.p=7*a,this.K=Math.floor(1e4*Math.random()),this.level=a}var io=require("sandbox-io"),noise=require("./js/perlin.js"),worlds=[],nextTankId=1,nextTokenId=1,nextPlayerId=1,players=[],maxPlayersPerLevel=20;Player.prototype.Qa=function(a){this.qa=worlds[this.level],this.qa.Ua.length>maxPlayersPerLevel&&(this.qa.Va(),worlds[this.level]=getNewWorld(this.level),this.qa=worlds[this.level],this.Ta=!0),this.ea=new Tank(0,this);var b={M:this.ea.Ka(),qa:this.qa.Ka(),Wa:this.Wa,Ta:this.Ta};a.emit("receive-game",b),this.Wa=this.ea},Player.prototype.Ra=function(a){this.qa.Xa(this.ea),this.qa.Pa(2,8),this.Ta=!1,a.Oa&&(this.level++,this.Ta=!0),this.level>6&&(this.level=0,this.Ta=!0),a.M.pa&&(this.pa=a.M.pa,this.ea.pa=a.M.pa),this.ea.B(a.Na.M)},Tank.prototype.Ka=function(){return{N:this.N,A:this.A,pa:this.pa}},Tank.prototype.B=function(a){this.A.xa.push.apply(this.A.xa,a.xa),this.A.ya.push.apply(this.A.ya,a.ya)},Token.prototype.Ka=function(){return{P:this.P,S:this.S,Za:this.Za,id:this.Za,A:this.A}},Token.prototype.B=function(a){this.A.push.apply(this.A,a)},World.prototype.Pa=function(a,b){noise.seed(this.K);for(var c=0,d=0;a>c||b>d;){var e=Math.floor(Math.random()*this.width),f=Math.floor(Math.random()*this.height),g=Math.abs(noise.perlin2(e/600,f/600));g*=256,g=Math.min(256,g+this.p),g>70&&77>g&&a>c&&(this.I.push(new Token(e,f)),c++),g<40+this.p&&b>d&&(this.J.push(new Token(e,f)),d++)}},World.prototype.Va=function(){this.Ua=[],this.I=[]},World.prototype.Xa=function(a){this.Ua.push(a)},World.prototype.B=function(a){this.A.push.apply(this.A,a.M)},World.prototype.Ka=function(){var a={p:this.p,level:this.level,G:this.G,height:this.height,width:this.width,K:this.K,players:this.Ua.map(function(a){return a.Ka()}),I:this.I.map(function(a){return a.Ka()}),J:this.J.map(function(a){return a.Ka()})};return a},startServer();