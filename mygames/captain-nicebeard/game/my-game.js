function getNewWorld(a){var b=new World(a);return b.Sa(5,15),b}function startServer(){for(var a=0;6>=a;a++)worlds.push(getNewWorld(a));io.on("connection",function(a){log.debug("New connection",a.id);var b=new Player;b.Ta(a),a.on("new-game",function(c){b.Ta(a)}),a.on("tank-state",function(a,c){b.Ua(a),c(!0)})})}function Player(){this.Va=nextPlayerId,nextPlayerId++,this.level=0,this.qa=worlds[this.level],this.A=[],this.Wa=!0,this.pa=""}function Tank(a,b){this.N=nextTankId,nextTankId++,this.ab=a,this.A={xa:[],ya:[],state:[]}}function Token(a,b){this.P=a,this.S=b,this._a=nextTokenId,this.A=[],nextTokenId++}function World(a){this.G=3e5,this.height=2e3+400*a,this.width=3e3+400*a,this.A=[],this.Xa=[],this.I=[],this.J=[],this.p=7*a,this.K=Math.floor(1e4*Math.random()),this.level=a}var io=require("sandbox-io"),noise=require("./js/perlin.js"),worlds=[],nextTankId=1,nextTokenId=1,nextPlayerId=1,players=[],maxPlayersPerLevel=20;Player.prototype.Ta=function(a){this.qa=worlds[this.level],this.qa.Xa.length>maxPlayersPerLevel&&(this.qa.Ya(),worlds[this.level]=getNewWorld(this.level),this.qa=worlds[this.level],this.Wa=!0),this.ea=new Tank(0,this);var b={M:this.ea.Ma(),qa:this.qa.Ma(),Za:this.Za,Wa:this.Wa};a.emit("receive-game",b),this.Za=this.ea},Player.prototype.Ua=function(a){this.qa.$a(this.ea),this.qa.Sa(2,8),this.Wa=!1,a.Ra&&(this.level++,this.Wa=!0),this.level>6&&(this.level=0,this.Wa=!0),a.M.pa&&(this.pa=a.M.pa,this.ea.pa=a.M.pa),this.ea.B(a.Qa.M),this.qa.I.forEach(function(b){if(a.Qa.I[b._a]){var c=a.Qa.I[b._a];b.B(c)}}),this.qa.J.forEach(function(b){if(a.Qa.J[b.id]){var c=a.Qa.J[b.id];b.B(c)}})},Tank.prototype.Ma=function(){return{N:this.N,A:this.A,pa:this.pa}},Tank.prototype.B=function(a){this.A.xa.push.apply(this.A.xa,a.xa),this.A.ya.push.apply(this.A.ya,a.ya),this.A.state.push.apply(this.A.state,a.state)},Token.prototype.Ma=function(){return{P:this.P,S:this.S,_a:this._a,id:this._a,A:this.A}},Token.prototype.B=function(a){this.A.push.apply(this.A,a)},World.prototype.Sa=function(a,b){noise.seed(this.K);for(var c=0,d=0;a>c||b>d;){var e=Math.floor(Math.random()*this.width),f=Math.floor(Math.random()*this.height),g=Math.abs(noise.perlin2(e/600,f/600));g*=256,g=Math.min(256,g+this.p),g>70&&77>g&&a>c&&(this.I.push(new Token(e,f)),c++),g<40+this.p&&b>d&&(this.J.push(new Token(e,f)),d++)}},World.prototype.Ya=function(){this.Xa=[],this.I=[]},World.prototype.$a=function(a){this.Xa.push(a)},World.prototype.B=function(a){this.A.push.apply(this.A,a.M),this.I.forEach(function(b){if(a.I[b._a]){var c=a.I[b._a];b.B(c)}})},World.prototype.Ma=function(){var a={p:this.p,level:this.level,G:this.G,height:this.height,width:this.width,K:this.K,players:this.Xa.map(function(a){return a.Ma()}),I:this.I.map(function(a){return a.Ma()}),J:this.J.map(function(a){return a.Ma()})};return a},startServer();