function Landscape(a,b,c,d,e){this.o=c,this.width=Math.floor(a/c),this.height=Math.floor(b/c),this.seed=d,this.canvas=gid("landscape"),this.mask=new Int32Array(this.width*this.height),this.p=e}function GameEvents(a){this.v=0,this.A=[],a&&this.B(a)}function World(a,b,c,d){this.G=a.G,this.width=a.width,this.height=a.height,this.level=a.level,this.p=a.p,this.H={},this.tokens={},this.I={},this.J=a.J,this.K=new Landscape(this.width,this.height,2,this.J,this.p),this.L=new Tank(this,b.M,!1,!0,c,d),a.players.forEach(function(a){this.H[a.M]=new Tank(this,a.M,a,!1,c)}.bind(this)),a.tokens.forEach(function(a){this.tokens[a.id]=new Token(a)}.bind(this)),a.I.forEach(function(a){this.I[a.id]=new Floater(a)}.bind(this)),this.N=this.L.O,this.P=this.L.R,this.S=gid("goocanvas").width,this.T=gid("goocanvas").height,this.U=!1}function Bullet(a,b,c,d,e,f){this.angle=d,this.da=a,this.O=b,this.R=c,this.ea=b,this.fa=c,this.ga=f,this.active=!0}function Tank(a,b,c,d,e,f){this.ia=d,this.na=c?c.na:0,this.oa=c?c.oa:"",this.angle=245;var g=a.K.q(0,25+a.p/2);this.O=g.x,this.R=g.y,this.M=b,this.pa=a,this.qa=!1,this.ra=!1,this.sa=!1,this.ta=0,this.ua=0,this.lastState=null,this.va=[],this.active=!0,this.ca={wa:[],xa:[]},this.ya=c?c.ya:0,this.za=10,this.Aa=0,this.A={wa:c?c.A.wa:[],xa:new GameEvents(c?c.A.xa:[])},this.A.wa.sort(function(a,b){return a.ga<b.ga?-1:1}),this.v=0}function gid(a){return document.getElementById(a)}function onLoad(){gid("landscape-wrap").style.width=window.innerWidth+"px",gid("landscape-wrap").style.height=window.innerHeight+"px";var a=new Landscape(window.innerWidth,window.innerHeight,2,2e3*Math.random(),5);a.s(),gid("nameform").onsubmit=function(a){return gid("intro").style.display="none",gid("info").style.display="block",maingame.k=function(a){return 32==g.keyCode?(startGame(gid("nameinput").value),!0):void 0},!1}}function startGame(a){function b(a){gid("saying").textContent=pirateSayings[Math.floor(pirateSayings.length*Math.random())],gid("newLevel").style.display="block",gid("info").style.display="none",gid("press-space").style.display="none",gid("overlay").className="show",gid("press-space").textContent=a,gid("loading-text").style.display="block"}var c=io(document.location.href);b("Press space to start game!"),maingame.Ka=function(a,d){if(b(d?"Press space to restart game.":a?"Press space to travel to next sea.":"Press space to retry this sea."),!a||d){if(gid("finalscore").textContent=(d?"CONGRATULATIONS! You have completed all seven seas. Your final score is ":"You scored ")+maingame.La,d)var e="Shiver me timbers! I completed Captain Nicebeard and scored "+maingame.La+". Can you do better? "+window.location.href;else if(maingame.Fa)var e="Avast! I scored "+maingame.La+" and crashed into "+maingame.Fa+" on Captain Nicebeard! "+window.location.href;else var e="Yarr! I scored "+maingame.La+" on Captain Nicebeard, the reverse pirate! "+window.location.href;var f="http://twitter.com/home/?status="+encodeURIComponent(e);gid("twit").textContent="Post to Twitter: "+e,gid("twit").href=f,gid("tweetthis").className="show"}else gid("tweetthis").className="";(!a||d)&&(maingame.La=0),maingame.Fa=!1,c.emit("new-game",{})},c.on("receive-game",function(b){b.L.oa=a,b.L.ya=maingame.La,newGame(b.pa,b.L,c,maingame,b.lastTank,a,b.landscapeChanged)})}function newGame(a,b,c,d,e,f,h){function i(){return Date.now()-l}function j(){function a(a,b){var d=i();c.emit("tank-state",{Ma:p.aa(d),Na:a,L:p.L.Ja()},b)}function b(b){var c=i();p.s(g,c),d.level=p.level,d.l=function(){},d.k=function(a){},p.L.Ha(c),window.setTimeout(function(){a(b,function(){d.Ka(b,6==p.level&&b)})},1e3)}l=Date.now(),showNotification("The "+(0==p.level?"Black Sea":"")+(1==p.level?"Caspian Sea":"")+(2==p.level?"Red Sea":"")+(3==p.level?"Mediterranean Sea":"")+(4==p.level?"Persian Gulf":"")+(5==p.level?"Adriatic Sea":"")+(6==p.level?"Arabian Sea":"")+" ("+(p.level+1)+" of 7) ahoy!");var e=i();p.L.Ha(e),d.k=function(a){if(122==a.keyCode||119==a.keyCode||121==a.keyCode)p.L.Ga(i(),-1);else{if(120!=a.keyCode)return!1;p.L.Ga(i(),1)}return!0},d.l=function(a){var c=i();p.s(a,c),p.L.active||b(!1),c>p.G&&(showNotification("Out of time!"),b(!1)),p.L.Aa>=RESCUE_GOAL&&(showNotification("Yarr! Sea "+(p.level+1)+" complete. "),b(!0)),d.La=p.L.ya,k()}}function k(){var a=(p.G-i())/1e3,b=Math.floor(a/60),c=Math.floor(a%60);m.textContent=b+":"+(10>c?"0":"")+c,n.textContent="Score: "+p.L.ya,o.textContent="Coins: "+p.L.za}var l=Date.now(),m=gid("worldTime"),n=gid("score"),o=gid("coins"),p=new World(a,b,i(),e);p.L.oa=f,p.L.ya=b.ya,p.V(),gid("press-space").style.display="block",gid("loading-text").style.display="none",d.k=function(a){return 32==a.keyCode?(gid("overlay").className="",j(),!0):void 0}}function dist(a,b){var c=a.O-b.O,d=a.R-b.R;return Math.sqrt(c*c+d*d)}function showNotification(a){var b=gid("notification-wrap"),c=gid("notification");c.textContent=a,b.className="show",hideNotification&&clearInterval(hideNotification),hideNotification=window.setInterval(function(){b.className="hide"},3e3)}var pirateSayings=["Yarr! No rum fer me thanks, I be tee-total.","Batten down the hatches! It be movie night.","Avast ye scurvy dogs. I be challenging ye to a game o' scrabble.","Spanish gallion yonder. Let us visit fo' tea and polite chat.","No need to loot anymore, ship mates. Our friendship is the real treasure.","This be no eye patch, it be the new Google Glass","Yarr! Welcome aboard, we have free wifi.","Pieces o' silver can't buy ye happiness.","No need fo' keelhauling, lets be settlin' our differences amicably.","Thar be no exercise betarr fer th' heart than reachin' below 'n liftin' shipmates up","Ye have not lived this day 'til ye have done somethin' fer a seadog who can never repay ye.","Be off away ye torrent downloads, I be buyin' all me films on DVD.","We be only treasurin' what us be givin'."],Goo=function(a){function b(){g();var a=f();c.l&&c.l(c,a),c.animate&&(h++>60&&(c.m=h/(a-i)*1e3,c.onFrameRate&&c.onFrameRate(c),h=0,i=a),e(b))}var c=this;if(c.type="2d",c.animate=!0,c.g=!1,c.h={},c.i={},a)for(var d in a)a.hasOwnProperty(d)&&(c[d]=a[d]);if(c.canvas=document.createElement("canvas"),c.canvas.id="goocanvas",c.canvas&&(c.ctx=c.canvas.getContext(c.type)),!c.canvas||!c.ctx&&c.onFailure)return void c.onFailure();c.canvas.width=c.width,c.canvas.height=c.height,Object.defineProperty(c,"width",{get:function(){return c.canvas.width},set:function(a){c.canvas.width=a}}),Object.defineProperty(c,"height",{get:function(){return c.canvas.height},set:function(a){c.canvas.height=a}}),c.g&&(c.j=document.body,document.body.style.margin="0px",document.body.style.padding="0px",document.body.style.overflow="hidden"),c.j&&c.j.appendChild(c.canvas);var e=function(){var a=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame;return a||(a=function(a){window.setTimeout(a,1e3/30)}),a}(),f=Date.now?Date.now:function(){return(new Date).getTime()};window.addEventListener("keydown",function(a){c.keyCode=a.keyCode?a.keyCode:a.charCode,c.key=String.fromCharCode(c.keyCode),c.h[c.keyCode]=!0,c.onKeyDown&&c.onKeyDown(c)},!1),window.addEventListener("keyup",function(a){c.keyCode=a.keyCode?a.keyCode:a.charCode,c.key=String.fromCharCode(c.keyCode),delete c.h[c.keyCode],c.onKeyUp&&c.onKeyUp(c)},!1),window.addEventListener("keypress",function(a){c.keyCode=a.keyCode?a.keyCode:a.charCode,c.key=String.fromCharCode(c.keyCode),c.k&&(c.k(c)||39==c.keyCode||37==c.keyCode)&&a.preventDefault()},!1);var g=function(){if(c.g){var a=window.innerWidth,b=window.innerHeight;c.canvas.width!=a&&(c.canvas.width=a),c.canvas.height!=b&&(c.canvas.height=b)}},h=0,i=f();e(b)};Landscape.prototype.q=function(a,b){noise.seed(this.seed);do{var c=Math.floor(Math.random()*this.width*this.o),d=Math.floor(Math.random()*this.height*this.o),e=Math.abs(noise.perlin2(c/600,d/600));e*=256,e=Math.min(256,e+this.p)}while(a>e||e>b);return{x:c,y:d}},Landscape.prototype.s=function(){this.canvas.width=this.width,this.canvas.height=this.height,this.canvas.style.width=this.width*this.o+"px",this.canvas.style.height=this.height*this.o+"px";var a=this.canvas.getContext("2d"),b=a.createImageData(this.width,this.height),c=b.data;noise.seed(this.seed);for(var d=0;d<this.width;d++)for(var e=0;e<this.height;e++){var f=Math.abs(noise.perlin2(d/(600/this.o),e/(600/this.o)));f*=256,f=Math.min(256,f+this.p);var g,h=Math.abs(noise.perlin2(d/20,e/20)),i=4*(d+e*this.width),j=Math.random();g=f>80?3:2,f>110-10*j?(f-=20*j,c[i]=0,c[i+1]=f,c[i+2]=0):f>80||Math.floor(f)==Math.floor(77-3*j)?(c[i]=255-10*Math.random()-(f-80),c[i+1]=c[i],c[i+2]=Math.max(0,255-30*(f-80))+-(20*h)):(f-=20*Math.random(),c[i]=0,c[i+1]=0,c[i+2]=235-20*h-20*Math.random()-Math.abs(.6*f-30)),this.mask[d+e*this.width]=g,c[i+3]=255}a.t="#000",a.fillRect(0,0,1e4,1e4),a.putImageData(b,0,0)},Landscape.prototype.move=function(a,b){this.canvas.style.left=-a,this.canvas.style.top=-b},Landscape.prototype.u=function(a){return a.x>0&&a.x<this.width*this.o&&a.y>0&&a.y<this.height*this.o?this.mask[Math.floor(a.x/this.o)+Math.floor(a.y/this.o)*this.width]:0},GameEvents.prototype.C=function(a,b){for(;this.v<this.A.length&&this.A[this.v].D<a;){var c=this.A[this.v],d=this.v>0?this.A[this.v-1]:null;b(c,d),this.v++}},GameEvents.prototype.F=function(){return this.v>=0&&this.v<this.A.length?this.A[this.v]:null},GameEvents.prototype.B=function(a){this.A=a,this.A.sort(function(a,b){return a.D<b.D?-1:1})},World.prototype.V=function(){this.K.s()},World.prototype.s=function(a,b){this.N=Math.max(0,this.L.O-this.S/2),this.P=Math.max(0,this.L.R-this.T/2),this.N=Math.min(this.N,this.width-this.S),this.P=Math.min(this.P,this.height-this.T),this.K.move(this.N,this.P),a.ctx.clearRect(0,0,a.width,a.height),a.ctx.save(),a.ctx.translate(-this.N,-this.P);var c=Date.now();this.W||(this.W=c);var d=(c-this.W)/1e3;this.W=c,b>.9*this.G&&!this.U&&(this.U=!0,showNotification("Time is running out!!")),Object.keys(this.tokens).forEach(function(c){Object.keys(this.H).forEach(function(a){this.tokens[c].X(this.H[a],b)}.bind(this)),this.tokens[c].X(this.L,b),this.tokens[c].Y(a,b,this)}.bind(this)),Object.keys(this.I).forEach(function(c){Object.keys(this.H).forEach(function(a){this.I[c].X(this.H[a],b)}.bind(this)),this.I[c].X(this.L,b),this.I[c].Y(a,b,this)}.bind(this)),Object.keys(this.H).forEach(function(c){this.H[c].Z(a,d,this,b),this.H[c].Y(a,b,this)}.bind(this)),this.L.$(a,b),this.L.Z(a,d,this,b),this.L.Y(a,b,this),a.ctx.restore()},World.prototype._=function(a){return a.O>this.N-100&&a.O<this.N+this.S+100&&a.R>this.P-100&&a.R<this.P+this.T+100},World.prototype.aa=function(a){return this.L.ba(a),{L:this.L.ca}},Bullet.prototype.Z=function(a,b,c){if(this.active){for(var d=0;10>d;d++){var e=0,f=30*a;f=-f;var g=(180+this.angle)*(Math.PI/180),h=e*Math.cos(g)-f*Math.sin(g),i=e*Math.sin(g)+f*Math.cos(g);this.O+=h,this.R+=i,Object.keys(b.H).forEach(function(a){var d=b.H[a];dist(d,this)<50&&d.active&&d!=this.da&&this.ha(d,c)}.bind(this)),this.da.ia||dist(b.L,this)<40&&this.ha(b.L,c),3==b.K.u({x:this.O,y:this.R})&&this.ja(c)}(this.O<-50||this.R<-50||this.O>b.width+50||this.R>b.height+50)&&this.ja(c)}},Bullet.prototype.ha=function(a,b){this.ja(b),this.da.ka(this,b,a),a.la(this,b)},Bullet.prototype.ja=function(a){this.active=!1},Bullet.prototype.Y=function(a,b,c){this.active&&c._(this)&&(a.ctx.save(),a.ctx.translate(this.O,this.R),a.ctx.scale(1,.2+(Math.cos((b-this.ga)/200)-.2)),a.ctx.fillStyle="#B88A0E",a.ctx.beginPath(),a.ctx.strokeStyle="#FDF1BF",a.ctx.arc(10,10,10,0,2*Math.PI,!1),a.ctx.stroke(),a.ctx.fill(),a.ctx.beginPath(),a.ctx.fillStyle="#DC8D24",a.ctx.arc(8,8,10,0,2*Math.PI,!1),a.ctx.stroke(),a.ctx.fill(),a.ctx.fillStyle="#FFEEBA",a.ctx.font="20px serif",a.ctx.fillText(String.fromCharCode(9733),0,15),a.ctx.restore())},Number.prototype.ma=function(a){return(this%a+a)%a},Tank.prototype.Z=function(a,b,c,d){if(this.active){for(;this.v<this.A.wa.length&&this.A.wa[this.v].ga<d;){var e=this.A.wa[this.v];this.Ba(e),this.v++}this.qa?(this.angle=(this.angle-TURN_SPEED*b)%360,this.ua=ACCELERATION/50):this.ra?(this.angle=(this.angle+TURN_SPEED*b)%360,this.ua=ACCELERATION/50):this.ua=ACCELERATION/10,this.ta=this.ta+this.ua*b,this.ta>MAX_FORWARD&&(this.ta=MAX_FORWARD);var f=this.Ca(this,{x:0,y:60*this.ta*b},this.angle);f.x<-50||f.x>=this.pa.width+50||f.y<-50||f.y>=this.pa.height+50?this.angle=this.angle+180:(this.O=f.x,this.R=f.y),3==this.u()&&this.Da(null,d),this.A.xa.C(d,function(a,b){a.Ea&&this.va.push(new Bullet(this,a.ea,a.fa,a.angle,d,a.ga))}.bind(this)),Object.keys(c.H).forEach(function(a){var b=c.H[a];dist(b,this)<50&&b.active&&b!=this&&(this.Da(b,d),b.Da(this,d))}.bind(this))}this.va.forEach(function(a){a.Z(b,c,d)})},Tank.prototype.Da=function(a,b){(!this.ia||b>3e3)&&(this.active=!1,this.ia&&a?(maingame.Fa=a.oa,showNotification("Shiver me timbers, we crashed into "+a.oa)):this.ia&&showNotification("Yar! We be scuttled."))},Tank.prototype.Ca=function(a,b,c){var d=c*(Math.PI/180),e=b.x*Math.cos(d)-b.y*Math.sin(d),f=b.x*Math.sin(d)+b.y*Math.cos(d);return{x:a.O+e,y:a.R+f}},Tank.prototype.u=function(){var a=this.pa.K.u(this.Ca(this,{x:-10,y:-50},this.angle)),b=this.pa.K.u(this.Ca(this,{x:10,y:-50},this.angle)),c=this.pa.K.u(this.Ca(this,{x:-10,y:50},this.angle)),d=this.pa.K.u(this.Ca(this,{x:10,y:50},this.angle));return Math.max(a,b,c,d)},Tank.prototype.Ga=function(a,b){if(this.za<=0)this.ia&&showNotification("No coins left. Collect the treasure chests.");else{var c=this.angle+45*b;this.va.push(new Bullet(this,this.O,this.R,c,a,a)),this.ca.xa.push({Ea:!0,D:a,ea:this.O,fa:this.R,ga:a,angle:c}),this.za--}},Tank.prototype.ka=function(a,b,c){this.ya+=30,this.ia&&showNotification("Booty returned to "+c.oa),a.ja(b)},Tank.prototype.la=function(a,b){this.za++},Tank.prototype.Ba=function(a){this.angle=a.angle,this.O=a.O,this.R=a.R,this.lastState&&(this.qa=a.qa,this.ra=a.ra),this.lastState=a},Tank.prototype.Y=function(a,b,c){if(c._(this)){var d=this.angle*(Math.PI/180);if(a.ctx.save(),a.ctx.translate(this.O,this.R),a.ctx.rotate(d),this.angle.ma(360)<180?a.ctx.rotate(-Math.PI/2):(a.ctx.rotate(Math.PI/2),a.ctx.scale(-1,1)),this.active||(a.ctx.scale(.6,-1),a.ctx.globalAlpha=.5),this.ia&&3e3>b&&(a.ctx.beginPath(),a.ctx.strokeStyle="rgba(128,255,128,"+Math.abs(Math.sin(b/200))+")",a.ctx.lineWidth="10",a.ctx.arc(5,-10,70,0,2*Math.PI,!1),a.ctx.stroke()),a.ctx.drawImage(sprite,0,0,126,118,-49.25,-92.75/1.5,98.5,92.75),!this.ia){a.ctx.restore(),a.ctx.save(),a.ctx.translate(this.O,this.R),a.ctx.strokeStyle="rgb(255,255,255)",a.ctx.font="17px serif";var e=a.ctx.measureText(this.oa);a.ctx.fillStyle="rgba(0,0,0,0.5)",a.ctx.fillRect(-e.width/2-5,40,e.width+10,20),a.ctx.fillStyle="#fff",a.ctx.fillText(this.oa,-e.width/2,55)}a.ctx.restore()}this.va.forEach(function(d){d.Y(a,b,c)})},Tank.prototype.$=function(a,b){var c=2*this.keyForward+4*this.keyReverse+8*this.qa+16*this.ra;this.qa=!!(a.h[37]||a.h[65]||a.h[52]),this.ra=!!(a.h[39]||a.h[68]||a.h[54]);var d=2*this.keyForward+4*this.keyReverse+8*this.qa+16*this.ra;d!=c&&this.Ha(b)},Tank.prototype.Ha=function(a){this.ba(a),this.ca.wa.push({M:this.M,ga:a,Ia:a,angle:this.angle,O:this.O,R:this.R,qa:this.qa,ra:this.ra,ta:this.ta,ua:this.ua})},Tank.prototype.ba=function(a){if(this.ca.wa.length){var b=this.ca.wa[this.ca.wa.length-1];b.ga=Math.min(b.ga,a),b.Ia=Math.max(b.Ia,a)}},Tank.prototype.Ja=function(){return{active:this.active,ca:this.ca,ya:this.ya,za:this.za,Aa:this.Aa,oa:this.oa}};var Token=Class.extend({init:function(a){this.O=a.O,this.R=a.R,this.visible=!0},Y:function(a,b,c){if(this.visible&&c._(this)){a.ctx.save(),a.ctx.translate(this.O,this.R);var d=((b+100*this.R)%1e3>500?500-(b+100*this.R)%500:(b+100*this.R)%500)/1e3;a.ctx.scale(1+d,1+.8*d),a.ctx.drawImage(sprite,0,191,106,109,-20.6875,-21.1875,331/8,339/8),a.ctx.restore()}},X:function(a,b){dist(this,a)<50&&this.visible&&(this.visible=!1,this.la(a,b))},la:function(a,b){a.za+=10,a.ia&&showNotification("Booty retrieved. Press Z / X to give gold to fellow ships.")},Ja:function(){}}),Floater=Token.extend({init:function(a){this._super(a,!1)},Y:function(a,b,c){if(this.visible&&c._(this)){a.ctx.save(),a.ctx.translate(this.O,this.R);var d=((b+100*this.R)%1e3>500?500-(b+100*this.R)%500:(b+100*this.R)%500)/500;a.ctx.rotate(d-.5),a.ctx.drawImage(sprite,0,125,112,62,-29.25,-229/6/2,58.5,229/6),a.ctx.restore()}},la:function(a,b){a.Aa++,a.ya+=10,a.ia&&showNotification("Shipmate rescued. "+(RESCUE_GOAL-a.Aa)+" to go!")}}),MAX_FORWARD=3,ACCELERATION=10,TURN_SPEED=80,RESCUE_GOAL=10,maingame={l:function(a){},Ka:function(){},Fa:!1,level:0,La:0,k:function(a){}},g=new Goo({g:!0,l:function(a){maingame.l(a)},k:function(a){return maingame.k(a)}}),hideNotification=!1,sprite=new Image;sprite.src="/img/sprites.svg",sprite.onload=onLoad;