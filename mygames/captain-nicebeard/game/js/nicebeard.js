function Landscape(a,b,c,d,e){this.o=c,this.width=Math.floor(a/c),this.height=Math.floor(b/c),this.seed=d,this.canvas=gid("landscape"),this.mask=new Int32Array(this.width*this.height),this.p=e}function GameEvents(a){this.v=0,this.A=[],a&&this.B(a)}function World(a,b,c,d){this.G=a.G,this.width=a.width,this.height=a.height,this.level=a.level,this.p=a.p,this.H={},this.I={},this.J={},this.K=a.K,this.L=new Landscape(this.width,this.height,2,this.K,this.p),this.M=new Tank(this,b.N,!1,!0,c,d),a.players.forEach(function(a){this.H[a.N]=new Tank(this,a.N,a,!1,c)}.bind(this)),a.I.forEach(function(a){this.I[a.tokenId]=new Token(a)}.bind(this)),a.J.forEach(function(a){this.J[a.id]=new Floater(a)}.bind(this)),this.O=this.M.P,this.R=this.M.S,this.T=gid("goocanvas").width,this.U=gid("goocanvas").height,this.V=!1}function Bullet(a,b,c,d,e,f){this.angle=d,this.ea=a,this.P=b,this.S=c,this.fa=b,this.ga=c,this.ha=f,this.active=!0}function Tank(a,b,c,d,e,f){this.ja=d,this.oa=c?c.oa:0,this.pa=c?c.pa:"",this.angle=245;var g=a.L.q(0,25+a.p/2);this.P=g.x,this.S=g.y,this.N=b,this.qa=a,this.ra=!1,this.sa=!1,this.ta=!1,this.ua=0,this.va=0,this.lastState=null,this.wa=[],this.active=!0,this.da={xa:[],ya:[]},this.za=c?c.za:0,this.Aa=0,this.Ba=0,this.A={xa:c?c.A.xa:[],ya:new GameEvents(c?c.A.ya:[])},this.A.xa.sort(function(a,b){return a.ha<b.ha?-1:1}),this.v=0}function gid(a){return document.getElementById(a)}function onLoad(){gid("landscape-wrap").style.width=g.width+"px",gid("landscape-wrap").style.height=g.height+"px";var a=new Landscape(g.width,g.height,2,2e3*Math.random(),5);a.s(),gid("nameform").onsubmit=function(a){return gid("intro").style.display="none",gid("info").style.display="block",maingame.k=function(a){return 32==g.keyCode?(startGame(gid("nameinput").value),!0):void 0},!1}}function startGame(a){function b(a){gid("saying").textContent=pirateSayings[Math.floor(pirateSayings.length*Math.random())],gid("newLevel").style.display="block",gid("info").style.display="none",gid("press-space").style.display="none",gid("overlay").className="show",gid("press-space").textContent=a,gid("loading-text").style.display="block"}var c=io(document.location.href);b("Press space to start game!"),maingame.La=function(a,d){if(b(d?"Press space to restart game.":a?"Press space to travel to next sea.":"Press space to retry this sea."),!a||d){if(gid("finalscore").textContent=(d?"CONGRATULATIONS! You have completed all seven seas. Your final score is ":"You scored ")+maingame.Ma,d)var e="Shiver me timbers! I completed Captain Nicebeard and scored "+maingame.Ma+". Can you do better? "+window.location.href;else if(maingame.Ga)var e="Avast! I scored "+maingame.Ma+" and crashed into "+maingame.Ga+" on Captain Nicebeard! "+window.location.href;else var e="Yarr! I scored "+maingame.Ma+" on Captain Nicebeard, the reverse pirate! "+window.location.href;var f="http://twitter.com/home/?status="+encodeURIComponent(e);gid("twit").textContent="Post to Twitter: "+e,gid("twit").href=f,gid("tweetthis").className="show"}else gid("tweetthis").className="";(!a||d)&&(maingame.Ma=0),maingame.Ga=!1,c.emit("new-game",{})},c.on("receive-game",function(b){b.M.pa=a,b.M.za=maingame.Ma,newGame(b.qa,b.M,c,maingame,b.lastTank,a,b.landscapeChanged)})}function newGame(a,b,c,d,e,f,h){function i(){return Date.now()-l}function j(){function a(a,b){var d=i();c.emit("tank-state",{Na:p.ba(d),Oa:a,M:p.M.Ka()},b)}function b(b){var c=i();p.s(g,c),d.level=p.level,d.l=function(){},d.k=function(a){},p.M.Ia(c),window.setTimeout(function(){a(b,function(){d.La(b,6==p.level&&b)})},1e3)}l=Date.now(),showNotification("Sea number "+(p.level+1)+" of 7 ahoy!");var e=i();p.M.Ia(e),d.k=function(a){if(122==a.keyCode)p.M.Ha(i(),-1);else{if(120!=a.keyCode)return!1;p.M.Ha(i(),1)}return!0},d.l=function(a){var c=i();p.s(a,c),p.M.active||b(!1),c>p.G&&(showNotification("Out of time!"),b(!1)),p.M.Ba>=RESCUE_GOAL&&(showNotification("Yarr! Sea "+(p.level+1)+" complete. "),b(!0)),d.Ma=p.M.za,k()}}function k(){var a=(p.G-i())/1e3,b=Math.floor(a/60),c=Math.floor(a%60);m.textContent=b+":"+(10>c?"0":"")+c,n.textContent="Score: "+p.M.za,o.textContent="Coins: "+p.M.Aa}var l=Date.now(),m=gid("worldTime"),n=gid("score"),o=gid("coins"),p=new World(a,b,i(),e);p.M.pa=f,p.M.za=b.za,p.W(),gid("press-space").style.display="block",gid("loading-text").style.display="none",d.k=function(a){return 32==a.keyCode?(gid("overlay").className="",j(),!0):void 0}}function dist(a,b){var c=a.P-b.P,d=a.S-b.S;return Math.sqrt(c*c+d*d)}function showNotification(a){var b=gid("notification-wrap"),c=gid("notification");c.textContent=a,b.className="show",hideNotification&&clearInterval(hideNotification),hideNotification=window.setInterval(function(){b.className="hide"},3e3)}var pirateSayings=["Yarr! No rum for me thanks, I'm tee-total.","Batten down the hatches! It's movie night.","Avast ye scurvy dogs. I be challenging ye to a game scrabble.","Spanish gallion yonder. Let us visit for tea and polite chat.","No need to loot anymore, ship mates. Our friendship is the real treasure.","This be no eye patch, it's the new Google Glass","Yarr! Welcome aboard, we have free wifi.","Pieces of silver can't buy you happiness.","No need for keelhauling, let's settle our differences amicably."],Goo=function(a){function b(){g();var a=f();c.l&&c.l(c,a),c.animate&&(h++>60&&(c.m=h/(a-i)*1e3,c.onFrameRate&&c.onFrameRate(c),h=0,i=a),e(b))}var c=this;if(c.type="2d",c.animate=!0,c.g=!1,c.h={},c.i={},a)for(var d in a)a.hasOwnProperty(d)&&(c[d]=a[d]);if(c.canvas=document.createElement("canvas"),c.canvas.id="goocanvas",c.canvas&&(c.ctx=c.canvas.getContext(c.type)),!c.canvas||!c.ctx&&c.onFailure)return void c.onFailure();c.canvas.width=c.width,c.canvas.height=c.height,Object.defineProperty(c,"width",{get:function(){return c.canvas.width},set:function(a){c.canvas.width=a}}),Object.defineProperty(c,"height",{get:function(){return c.canvas.height},set:function(a){c.canvas.height=a}}),c.g&&(c.j=document.body,document.body.style.margin="0px",document.body.style.padding="0px",document.body.style.overflow="hidden"),c.j&&c.j.appendChild(c.canvas);var e=function(){var a=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame;return a||(a=function(a){window.setTimeout(a,1e3/30)}),a}(),f=Date.now?Date.now:function(){return(new Date).getTime()};window.addEventListener("keydown",function(a){c.keyCode=a.keyCode?a.keyCode:a.charCode,c.key=String.fromCharCode(c.keyCode),c.h[c.keyCode]=!0,c.onKeyDown&&c.onKeyDown(c)},!1),window.addEventListener("keyup",function(a){c.keyCode=a.keyCode?a.keyCode:a.charCode,c.key=String.fromCharCode(c.keyCode),delete c.h[c.keyCode],c.onKeyUp&&c.onKeyUp(c)},!1),window.addEventListener("keypress",function(a){c.keyCode=a.keyCode?a.keyCode:a.charCode,c.key=String.fromCharCode(c.keyCode),c.k&&(c.k(c)||39==c.keyCode||37==c.keyCode)&&a.preventDefault()},!1);var g=function(){if(c.g){var a=window.innerWidth,b=window.innerHeight;c.canvas.width!=a&&(c.canvas.width=a),c.canvas.height!=b&&(c.canvas.height=b)}},h=0,i=f();e(b)};Landscape.prototype.q=function(a,b){noise.seed(this.seed);do{var c=Math.floor(Math.random()*this.width*this.o),d=Math.floor(Math.random()*this.height*this.o),e=Math.abs(noise.perlin2(c/600,d/600));e*=256,e=Math.min(256,e+this.p)}while(a>e||e>b);return{x:c,y:d}},Landscape.prototype.s=function(){this.canvas.width=this.width,this.canvas.height=this.height,this.canvas.style.width=this.width*this.o+"px",this.canvas.style.height=this.height*this.o+"px";var a=this.canvas.getContext("2d"),b=a.createImageData(this.width,this.height),c=b.data;noise.seed(this.seed);for(var d=0;d<this.width;d++)for(var e=0;e<this.height;e++){var f=Math.abs(noise.perlin2(d/(600/this.o),e/(600/this.o)));f*=256,f=Math.min(256,f+this.p);var g,h=Math.abs(noise.perlin2(d/20,e/20)),i=4*(d+e*this.width),j=Math.random();g=f>80?3:2,f>110-10*j?(f-=20*j,c[i]=0,c[i+1]=f,c[i+2]=0):f>80||Math.floor(f)==Math.floor(77-3*j)?(c[i]=255-10*Math.random()-(f-80),c[i+1]=c[i],c[i+2]=Math.max(0,255-30*(f-80))+-(20*h)):(f-=20*Math.random(),c[i]=0,c[i+1]=0,c[i+2]=235-20*h-20*Math.random()-Math.abs(.6*f-30)),this.mask[d+e*this.width]=g,c[i+3]=255}a.t="#000",a.fillRect(0,0,1e4,1e4),a.putImageData(b,0,0)},Landscape.prototype.move=function(a,b){this.canvas.style.left=-a,this.canvas.style.top=-b},Landscape.prototype.u=function(a){return a.x>0&&a.x<this.width*this.o&&a.y>0&&a.y<this.height*this.o?this.mask[Math.floor(a.x/this.o)+Math.floor(a.y/this.o)*this.width]:0},GameEvents.prototype.C=function(a,b){for(;this.v<this.A.length&&this.A[this.v].D<a;){var c=this.A[this.v],d=this.v>0?this.A[this.v-1]:null;b(c,d),this.v++}},GameEvents.prototype.F=function(){return this.v>=0&&this.v<this.A.length?this.A[this.v]:null},GameEvents.prototype.B=function(a){this.A=a,this.A.sort(function(a,b){return a.D<b.D?-1:1})},World.prototype.W=function(){this.L.s()},World.prototype.s=function(a,b){this.O=Math.max(0,this.M.P-this.T/2),this.R=Math.max(0,this.M.S-this.U/2),this.O=Math.min(this.O,this.width-this.T),this.R=Math.min(this.R,this.height-this.U),this.L.move(this.O,this.R),a.ctx.clearRect(0,0,a.width,a.height),a.ctx.save(),a.ctx.translate(-this.O,-this.R);var c=Date.now();this.X||(this.X=c);var d=(c-this.X)/1e3;this.X=c,b>.9*this.G&&!this.V&&(this.V=!0,showNotification("Time is running out!!")),Object.keys(this.I).forEach(function(c){Object.keys(this.H).forEach(function(a){this.I[c].Y(this.H[a],b)}.bind(this)),this.I[c].Y(this.M,b),this.I[c].Z(a,b,this)}.bind(this)),Object.keys(this.J).forEach(function(c){Object.keys(this.H).forEach(function(a){this.J[c].Y(this.H[a],b)}.bind(this)),this.J[c].Y(this.M,b),this.J[c].Z(a,b,this)}.bind(this)),Object.keys(this.H).forEach(function(c){this.H[c].$(a,d,this,b),this.H[c].Z(a,b,this)}.bind(this)),this.M._(a,b),this.M.$(a,d,this,b),this.M.Z(a,b,this),a.ctx.restore()},World.prototype.aa=function(a){return a.P>this.O-100&&a.P<this.O+this.T+100&&a.S>this.R-100&&a.S<this.R+this.U+100},World.prototype.ba=function(a){return this.M.ca(a),{M:this.M.da,I:Object.keys(this.I).reduce(function(a,b){return a[b]=this.I[b].da,a}.bind(this),{}),J:Object.keys(this.J).reduce(function(a,b){return a[b]=this.J[b].da,a}.bind(this),{})}},Bullet.prototype.$=function(a,b,c){if(this.active){for(var d=0;10>d;d++){var e=0,f=30*a;f=-f;var g=(180+this.angle)*(Math.PI/180),h=e*Math.cos(g)-f*Math.sin(g),i=e*Math.sin(g)+f*Math.cos(g);this.P+=h,this.S+=i,Object.keys(b.H).forEach(function(a){var d=b.H[a];dist(d,this)<50&&d.active&&d!=this.ea&&this.ia(d,c)}.bind(this)),this.ea.ja||dist(b.M,this)<40&&this.ia(b.M,c),3==b.L.u({x:this.P,y:this.S})&&this.ka(c)}(this.P<-50||this.S<-50||this.P>b.width+50||this.S>b.height+50)&&this.ka(c)}},Bullet.prototype.ia=function(a,b){this.ka(b),this.ea.la(this,b,a),a.ma(this,b)},Bullet.prototype.ka=function(a){this.active=!1},Bullet.prototype.Z=function(a,b,c){this.active&&c.aa(this)&&(a.ctx.save(),a.ctx.translate(this.P,this.S),a.ctx.scale(1,.2+(Math.cos((b-this.ha)/200)-.2)),a.ctx.fillStyle="#B88A0E",a.ctx.beginPath(),a.ctx.strokeStyle="#FDF1BF",a.ctx.arc(10,10,10,0,2*Math.PI,!1),a.ctx.stroke(),a.ctx.fill(),a.ctx.beginPath(),a.ctx.fillStyle="#DC8D24",a.ctx.arc(8,8,10,0,2*Math.PI,!1),a.ctx.stroke(),a.ctx.fill(),a.ctx.fillStyle="#FFEEBA",a.ctx.font="20px serif",a.ctx.fillText(String.fromCharCode(9733),0,15),a.ctx.restore())},Number.prototype.na=function(a){return(this%a+a)%a},Tank.prototype.$=function(a,b,c,d){if(this.active){for(;this.v<this.A.xa.length&&this.A.xa[this.v].ha<d;){var e=this.A.xa[this.v];this.Ca(e),this.v++}this.ra?(this.angle=(this.angle-TURN_SPEED*b)%360,this.va=ACCELERATION/50):this.sa?(this.angle=(this.angle+TURN_SPEED*b)%360,this.va=ACCELERATION/50):this.va=ACCELERATION/10,this.ua=this.ua+this.va*b,this.ua>MAX_FORWARD&&(this.ua=MAX_FORWARD);var f=this.Da(this,{x:0,y:60*this.ua*b},this.angle);f.x<-50||f.x>=this.qa.width+50||f.y<-50||f.y>=this.qa.height+50?this.angle=this.angle+180:(this.P=f.x,this.S=f.y),3==this.u()&&this.Ea(null,d),this.A.ya.C(d,function(a,b){a.Fa&&this.wa.push(new Bullet(this,a.fa,a.ga,a.angle,d,a.ha))}.bind(this)),Object.keys(c.H).forEach(function(a){var b=c.H[a];dist(b,this)<50&&b.active&&b!=this&&(this.Ea(b,d),b.Ea(this,d))}.bind(this))}this.wa.forEach(function(a){a.$(b,c,d)})},Tank.prototype.Ea=function(a,b){(!this.ja||b>3e3)&&(this.active=!1,this.ja&&a?(maingame.Ga=a.pa,showNotification("Shiver me timbers, we crashed into "+a.pa)):this.ja&&showNotification("Yar! We be scuttled."))},Tank.prototype.Da=function(a,b,c){var d=c*(Math.PI/180),e=b.x*Math.cos(d)-b.y*Math.sin(d),f=b.x*Math.sin(d)+b.y*Math.cos(d);return{x:a.P+e,y:a.S+f}},Tank.prototype.u=function(){var a=this.qa.L.u(this.Da(this,{x:-10,y:-50},this.angle)),b=this.qa.L.u(this.Da(this,{x:10,y:-50},this.angle)),c=this.qa.L.u(this.Da(this,{x:-10,y:50},this.angle)),d=this.qa.L.u(this.Da(this,{x:10,y:50},this.angle));return Math.max(a,b,c,d)},Tank.prototype.Ha=function(a,b){if(this.Aa<=0)this.ja&&showNotification("No coins left. Collect the treasure chests.");else{var c=this.angle+45*b;this.wa.push(new Bullet(this,this.P,this.S,c,a,a)),this.da.ya.push({Fa:!0,D:a,fa:this.P,ga:this.S,ha:a,angle:c}),this.Aa--}},Tank.prototype.la=function(a,b,c){this.za+=30,this.ja&&showNotification("Booty returned to "+c.pa),a.ka(b)},Tank.prototype.ma=function(a,b){this.Aa++},Tank.prototype.Ca=function(a){this.angle=a.angle,this.P=a.P,this.S=a.S,this.lastState&&(this.ra=a.ra,this.sa=a.sa),this.lastState=a},Tank.prototype.Z=function(a,b,c){if(c.aa(this)){var d=this.angle*(Math.PI/180);if(a.ctx.save(),a.ctx.translate(this.P,this.S),a.ctx.rotate(d),this.angle.na(360)<180?a.ctx.rotate(-Math.PI/2):(a.ctx.rotate(Math.PI/2),a.ctx.scale(-1,1)),this.active||(a.ctx.scale(.6,-1),a.ctx.globalAlpha=.5),this.ja&&3e3>b&&(a.ctx.beginPath(),a.ctx.strokeStyle="rgba(128,255,128,"+Math.abs(Math.sin(b/200))+")",a.ctx.lineWidth="10",a.ctx.arc(5,-10,70,0,2*Math.PI,!1),a.ctx.stroke()),a.ctx.drawImage(sprite,0,0,126,118,-49.25,-92.75/1.5,98.5,92.75),!this.ja){a.ctx.restore(),a.ctx.save(),a.ctx.translate(this.P,this.S),a.ctx.strokeStyle="rgb(255,255,255)",a.ctx.font="17px serif";var e=a.ctx.measureText(this.pa);a.ctx.fillStyle="rgba(0,0,0,0.5)",a.ctx.fillRect(-e.width/2-5,40,e.width+10,20),a.ctx.fillStyle="#fff",a.ctx.fillText(this.pa,-e.width/2,55)}a.ctx.restore()}this.wa.forEach(function(d){d.Z(a,b,c)})},Tank.prototype._=function(a,b){var c=2*this.keyForward+4*this.keyReverse+8*this.ra+16*this.sa;this.ra=!!(a.h[37]||a.h[65]||a.h[52]),this.sa=!!(a.h[39]||a.h[68]||a.h[54]);var d=2*this.keyForward+4*this.keyReverse+8*this.ra+16*this.sa;d!=c&&this.Ia(b)},Tank.prototype.Ia=function(a){this.ca(a),this.da.xa.push({N:this.N,ha:a,Ja:a,angle:this.angle,P:this.P,S:this.S,ra:this.ra,sa:this.sa,ua:this.ua,va:this.va})},Tank.prototype.ca=function(a){if(this.da.xa.length){var b=this.da.xa[this.da.xa.length-1];b.ha=Math.min(b.ha,a),b.Ja=Math.max(b.Ja,a)}},Tank.prototype.Ka=function(){return{active:this.active,da:this.da,za:this.za,Aa:this.Aa,Ba:this.Ba,pa:this.pa}};var Token=Class.extend({init:function(a){this.P=a.P,this.S=a.S,this.visible=!0},Z:function(a,b,c){if(this.visible&&c.aa(this)){a.ctx.save(),a.ctx.translate(this.P,this.S);var d=((b+100*this.S)%1e3>500?500-(b+100*this.S)%500:(b+100*this.S)%500)/1e3;a.ctx.scale(1+d,1+.8*d),a.ctx.drawImage(sprite,0,191,106,109,-20.6875,-21.1875,331/8,339/8),a.ctx.restore()}},Y:function(a,b){dist(this,a)<50&&this.visible&&(this.visible=!1,this.ma(a,b))},ma:function(a,b){a.Aa+=10,a.ja&&showNotification("Booty retrieved. Press Z / X to give gold to fellow ships.")},Ka:function(){}}),Floater=Token.extend({init:function(a){this._super(a,!1)},Z:function(a,b,c){if(this.visible&&c.aa(this)){a.ctx.save(),a.ctx.translate(this.P,this.S);var d=((b+100*this.S)%1e3>500?500-(b+100*this.S)%500:(b+100*this.S)%500)/500;a.ctx.rotate(d-.5),a.ctx.drawImage(sprite,0,125,112,62,-29.25,-229/6/2,58.5,229/6),a.ctx.restore()}},ma:function(a,b){a.Ba++,a.za+=10,a.ja&&showNotification("Shipmate rescued. "+(RESCUE_GOAL-a.Ba)+" to go!")}}),MAX_FORWARD=3,ACCELERATION=10,TURN_SPEED=80,RESCUE_GOAL=10,maingame={l:function(a){},La:function(){},Ga:!1,level:0,Ma:0,k:function(a){}},g=new Goo({g:!0,l:function(a){maingame.l(a)},k:function(a){return maingame.k(a)}}),hideNotification=!1,sprite=new Image;sprite.src="/img/sprites.svg",sprite.onload=onLoad;